#!/bin/bash

# Find the directory of the script and change to it
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"
# Project root, adjust as needed
PROJECT_DIR="$( cd $SCRIPT_DIR &> /dev/null && pwd )"
cd "$SCRIPT_DIR"
# Strip the script path to be relative to project root
SCRIPT_PATH="${0#$PROJECT_DIR}"; [[ ! "$SCRIPT_PATH" =~ ^\..*$ ]] && SCRIPT_PATH=".$SCRIPT_PATH"



############################################################################################
SHORT_DESC="testing"
############################################################################################

# These lists will be parsed and used for the help output and validation
VALID_COMMANDS=("distclean:Perform a deep clean of the code repos"
                "clean:Clean the code repos"
                "generate:Generate code from specs"
                "build:Build the code"
                "upload:Upload the docker image"
                "clienttest:Run client test"
                "install:Install the project to the instance"
                "help:Show help for TARGET")
VALID_FLAGS=("--help|-h:Show help for this script"
               "--debug:Enable debug mode"
               "--dryrun:Dryrun.  Don't actually run the commands"
               "--verbose:Verbose output")
FLAGS_EXPANSIONS=("--debug:--debug --verbose")
COMMAND_EXPANSIONS=("distclean:distclean clean"
                    "init:generate init")

FLAGS=("--verbose")
COMMANDS=()
# Parse command line arguments
#cli_parser $@

COMMANDS+=($1)


# find an flag in a list of valid flags
parse_flags() {
  local i=$1
  for flag in "${FLAGS[@]}"; do
    if [ "$flag" == "$i" ]; then
      echo "$1"
      break
    fi
  done
}


# Allows --dryrun to not actually run the commands
# also allows --verbose to show the commands being run
run_command() {
  local command="$1"
  if [ ! -z "$(parse_flags '--dryrun')" ] || [ ! -z "$(parse_flags '--verbose')" ]; then
    local LPWD=$(pwd)
    local PWD="${LPWD#$PROJECT_DIR}"
    if [ ! -z "$(parse_flags '--dryrun')" ]; then
      echo "    Would have run '$command' from '$PWD'"
    else
      echo "    Running '$command' from '$PWD'"
    fi
  fi
  if [ -z "$(parse_flags '--dryrun')" ]; then
    eval "$command"
  fi
}


function hash_password () {
    local password="$1"
    salt=$(openssl rand -base64 16)
    hashed_password=$(openssl passwd -6 -salt "$salt" "$password")
    echo "$hashed_password"
}

PACKER_BASEDIR="$SCRIPT_DIR"
PACKER_OUTPUT="$PACKER_BASEDIR/output"
PACKER_IMAGE_DEFS="$PACKER_BASEDIR/qemu_images"

export PKR_VAR_vmimage="ubuntu2404"

export PKR_VAR_username="packer"
export PKR_VAR_password="packer"
export PKR_VAR_output_directory="$PACKER_OUTPUT/${PKR_VAR_vmimage}"
export PKR_VAR_hashedpassword="$(hash_password $PKR_VAR_password)"


echo "PACKER_BASEDIR: $PACKER_BASEDIR"
echo "PACKER_OUTPUT: $PACKER_OUTPUT"
echo "PACKER_IMAGE_DEFS: $PACKER_IMAGE_DEFS"


echo "  ##################################################################"
echo "  # Running '$SCRIPT_PATH' script"
echo "  #   Commands: ${COMMANDS[@]}"
echo "  #   Flags: ${FLAGS[@]}"
echo "  #   Options: ${OPTIONS[@]}"
echo "  #-----------------------------------------------------------------"

# Execute the command
for COMMAND in "${COMMANDS[@]}"; do
  case "$COMMAND" in
    distclean)
      echo "  Distcleaning..."
      run_command "rm -rf ${PACKER_OUTPUT}"
      ;;
    clean)
      echo "  Cleaning..."
      run_command "rm -rf ${PKR_VAR_output_directory}"
      ;;
    build)
      echo "  Building..."
      cd ${PACKER_IMAGE_DEFS}/${PKR_VAR_vmimage}/http
      run_command "envsubst < user-data.tpl > user-data"
      cd ${PACKER_IMAGE_DEFS}/${PKR_VAR_vmimage}
      run_command "packer build ."
      ;;
    upload)
      echo "  Upload image..."
      echo "UNIMPLEMENTED"
      ;;
    *)
      echo "command '$COMMAND' not implemented"
      show_usage
      exit 1
      ;;
  esac
done

echo "  #-----------------------------------------------------------------"
echo "  # '$SCRIPT_PATH' script DONE"
echo "  ##################################################################"
